---
# roles/deploy/defaults/main.yml
postgresql_version: 17
# postgresql_repo: https://download.postgresql.org/pub/repos/yum/reporpms/EL-9-x86_64/pgdg-redhat-repo-latest.noarch.rpm
postgresql_action: install
postgresql_dir_owner: postgres
postgresql_dir_permissions: "0750"
postgresql_file_permissions: "0644"
postgresql_data_dir: /data/database/pgsql
postgresql_log_dir: /data/logs/pgsql
postgresql_backup_dir: /data/backup/pgsql

instance_defaults:
  postgresql_port: 5432
  postgresql_listen_address: '*'
  postgresql_log_directroy: /data/logs/pgsql/pgsql
  postgresql_backup_directory: /data/backup/pgsql/pgsql
  postgresql_max_connections: 100
  # - Security and Authentication -
  postgresql_ssl: 'off'
  postgresql_ssl_ca_file: ''
  postgresql_ssl_cert_file: ''
  postgresql_ssl_key_file: ''
  postgresql_password_encryption: 'scram-sha-256'

  # - Memory Settings -
  postgresql_shared_buffers: '1GB'
  postgresql_work_mem: '4MB'
  postgresql_maintenance_work_mem: '1024MB'
  postgresql_effective_cache_size: '3GB'
  postgresql_checkpoint_completion_target: '0.9'
  postgresql_wal_buffers: '16MB'
  postgresql_huge_pages: 'off'
  # - Kernel Resource Usage -
  postgresql_max_files_per_process: 1000
  postgresql_shared_preload_libraries: ''
  # - Cost-based Vacuum Delay -
  postgresql_autovacuum: 'on'
  postgresql_autovacuum_naptime: '1min'
  postgresql_autovacuum_vacuum_threshold: 50
  postgresql_autovacuum_analyze_threshold: 50
  postgresql_autovacuum_work_mem: '512MB'
  # - Write Ahead Log -
  postgresql_wal_level: 'replica'
  postgresql_archive_mode: 'off'
  postgresql_archive_command: ''
  postgresql_max_wal_size: '1GB'
  postgresql_min_wal_size: '80MB'
  # - Replication -
  postgresql_max_wal_senders: 10
  postgresql_wal_keep_size: '64MB'
  postgresql_hot_standby: 'on'
  # - Query Tuning -
  postgresql_default_statistics_target: 100
  postgresql_random_page_cost: 1.1
  postgresql_effective_io_concurrency: 200
  postgresql_max_worker_processes: 4
  postgresql_max_parallel_workers_per_gather: 2
  postgresql_max_parallel_workers: 4
  postgresql_max_parallel_maintenance_workers: 2
  # - Logging -
  postgresql_logging_collector: 'on'
  postgresql_log_directory: '/data/logs/pgsql'
  postgresql_log_filename: 'postgresql-%Y-%m-%d_%H%M%S.log'
  postgresql_log_rotation_age: '1d'
  postgresql_log_rotation_size: '0'
  postgresql_log_min_duration_statement: -1
  postgresql_log_line_prefix: '%m [%p] %d %u %a %h %e'
  postgresql_log_timezone: 'UTC'
  postgresql_log_destination: 'csvlog'
  # - Locale and Formatting -
  postgresql_datestyle: 'iso, mdy'
  postgresql_timezone: 'Europe/Berlin'
  postgresql_lc_messages: 'en_US.UTF-8'
  postgresql_lc_monetary: 'en_US.UTF-8'
  postgresql_lc_numeric: 'en_US.UTF-8'
  postgresql_lc_time: 'en_US.UTF-8'
  postgresql_default_text_search_config: 'pg_catalog.german'
  postgresql_custom_settings: ''

postgresql_instances:
  - instance_name: pgsql
    master: true


pg_hba_entries:
  - "# CommVault requires NOT to have peer-auth for user postgres active."
  - "# local   all             postgres                                peer"
  - "### CommVault setting"
  - local   all             all                                     scram-sha-256"
  - host    all             all             127.0.0.1/32            scram-sha-256"
  - host    all             all             ::1/128                 md5"
  - ""
  - "# Allow replication connections from localhost, by a user with the replication privilege."
  - "local   replication     all                                     peer"
  - "host    replication     all             127.0.0.1/32            scram-sha-256"
  - "host    replication     all             ::1/128                 scram-sha-256"
  - ""
  - "### JUMPHOST ACCESS"
  - "host    all             all             172.25.139.21/32         scram-sha-256"
  - "host    all             all             172.25.139.22/32         scram-sha-256"


postgresql_dirs:
  - "{{ postgresql_data_dir }}"
  - "{{ postgresql_log_dir }}"
  - "{{ postgresql_backup_dir }}"
